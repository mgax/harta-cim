<!doctype html>
<meta charset="utf-8">
<style>

.county { fill: none; pointer-events: all }
.county.show { fill: #eef }
.borders { fill: none; stroke: black; stroke-width: .5px }
.popup { display: none }
.show .popup { display: block }
.popup rect { fill: white; stroke: blue; stroke-width: 1px }
.popup iframe { border: none; width: 100%; height: 100% }
.popup iframe body { z-index: 100; background: blue }

</style>
<body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser-polyfill.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.16/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.20/topojson.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/0.11.0/fetch.min.js"></script>
<script type="text/babel">

let width = 600
let height = 600

let popupWidth = 200
let popupHeight = 150

let quantize = d3.scale.quantize()
    .domain([0, .15])
    .range(d3.range(9).map(function(i) { return 'q' + i + '-9' }))

let projection = d3.geo.stereographic()
    .scale(8000)
    .translate([width / 2, height / 2])
    .rotate([-25, -46])

let path = d3.geo.path()
    .projection(projection)

let svg = d3.select('body').append('svg')
    .attr('width', width)
    .attr('height', height)

function getJson(url) {
  return new Promise((resolve, reject) => {
    d3.json(url, (err, res) => {
      if(err) return reject(err)
      resolve(res)
    })
  })
}

async function main() {
  let judete = await getJson('judete.topojson')
  let siruta = await getJson('siruta.json')
  let judeteFeatures = topojson.feature(judete, judete.objects.judete).features

  function toggler(show) {
    return function(d) {
      d3.select(this).classed('show', show)
    }
  }

  svg.append('path')
      .datum(topojson.mesh(judete, judete.objects.judete, (a, b) => a !== b))
      .attr('class', 'borders')
      .attr('d', path)

  svg.append('path')
      .datum(topojson.merge(judete, judete.objects.judete.geometries))
      .attr('class', 'borders')
      .attr('d', path)

  let gCounty = svg.append('g')
    .selectAll('.county')
      .data(judeteFeatures)
    .enter().append('g')
      .classed('county', true)
      .on('mouseover', toggler(true))
      .on('mouseout', toggler(false))

  gCounty.append('path')
      .attr('id', (d) => `judet-${d.properties.id}`)
      .attr('d', path)

  let gPopup = gCounty.append('g')
      .classed('popup', true)
      .attr('id', (d) => `popup-${d.properties.id}`)
      .attr('transform', (d) => `translate(${path.centroid(d)}) translate(0,10)`)

  gPopup.append('rect')
      .attr('width', popupWidth)
      .attr('height', popupHeight)
      .attr('x', -popupWidth/2)
      .attr('rx', 5)
      .attr('ry', 5)

  gPopup.append('foreignObject')
      .attr('width', popupWidth)
      .attr('height', popupHeight)
      .attr('x', -popupWidth/2)
      .append('xhtml:body')
        .html((d) => `
          <h2>${siruta[d.properties.id]}</h2>
          <iframe src="judete/${siruta[d.properties.id]}.html">
        `)
}

main().catch((e) => { console.error(e.stack || e) })

</script>
