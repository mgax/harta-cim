<!doctype html>
<meta charset="utf-8">
<style>

.county { fill: white }
.borders { fill: none; stroke: black; stroke-width: .5px }
.popup { display: none }
.popup.popup-show { display: block }

</style>
<body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser-polyfill.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.16/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.20/topojson.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/0.11.0/fetch.min.js"></script>
<script type="text/babel">

let width = 600
let height = 600

let quantize = d3.scale.quantize()
    .domain([0, .15])
    .range(d3.range(9).map(function(i) { return 'q' + i + '-9' }))

let projection = d3.geo.stereographic()
    .scale(8000)
    .translate([width / 2, height / 2])
    .rotate([-25, -46])

let path = d3.geo.path()
    .projection(projection)

let svg = d3.select('body').append('svg')
    .attr('width', width)
    .attr('height', height)

function getJson(url) {
  return new Promise((resolve, reject) => {
    d3.json(url, (err, res) => {
      if(err) return reject(err)
      resolve(res)
    })
  })
}

async function main() {
  let judete = await getJson('judete.topojson')
  let siruta = await getJson('siruta.json')
  let judeteFeatures = topojson.feature(judete, judete.objects.judete).features

  function toggler(show) {
    return function(d) {
      d3.select(`#popup-${d.properties.id}`)
        .classed('popup-show', show)
    }
  }

  svg.append('g')
    .selectAll('.county')
      .data(judeteFeatures)
    .enter().append('path')
      .classed('county', true)
      .attr('id', (d) => `judet-${d.properties.id}`)
      .attr('d', path)
      .on('mouseover', toggler(true))
      .on('mouseout', toggler(false))

  svg.append('g')
    .selectAll('.popup')
      .data(judeteFeatures)
    .enter().append('g')
      .classed('popup', true)
      .attr('id', (d) => `popup-${d.properties.id}`)
      .attr('transform', (d) => `translate(${path.centroid(d)})`)
      .append('foreignObject')
        .attr('width', 100)
        .attr('height', 100)
        .append('xhtml:body')
          .html((d) => `<iframe src="judete/${siruta[d.properties.id]}.html">`)

  svg.append('path')
      .datum(topojson.mesh(judete, judete.objects.judete, (a, b) => a !== b))
      .attr('class', 'borders')
      .attr('d', path)

  svg.append('path')
      .datum(topojson.merge(judete, judete.objects.judete.geometries))
      .attr('class', 'borders')
      .attr('d', path)
}

main().catch((e) => { console.error(e.stack || e) })

</script>
